<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Smash Betting</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .AWAITING_PREDICTION { background: #e2e3e5; color: #383d41; }
        .BETTING { background: #cce5ff; color: #004085; }
        .BONUS_ACTIVE { background: #fff3cd; color: #856404; }
        .IN_PROGRESS { background: #d4edda; color: #155724; }
        .CLOSED { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; margin-right: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        #log-container { height: 250px; overflow-y: auto; background: #222; color: #eee; padding: 10px; font-family: monospace; border-radius: 4px; }
        .log-success { color: #51cf66; }
        .log-fail { color: #ff6b6b; border-left: 3px solid #ff6b6b; padding-left: 5px; }
    </style>
</head>
<body>
    <h1>Panneau Admin - Smash Betting</h1>

    <div class="card">
        <h2>Contrôle du Match</h2>
        <p>Statut : <span id="match-status" class="status-badge CLOSED">CLOSED</span> | ID : <span id="match-id-display">-</span></p>
        
        <button id="btn-start-match" onclick="startNewMatch()">1. Démarrer Nouveau Match</button>
        
        <div style="margin-top: 20px;">
            <label>Timer Bonus : </label>
            <input type="number" id="bonus-duration" value="20" style="width: 50px;">
            <button id="btn-start-bonus" onclick="startBonusPhase()" disabled>2. Lancer Phase Bonus</button>
            <button id="btn-stop-bonus" onclick="stopBonusPhase()" style="background:#e67e22" disabled>Arrêter Bonus</button>
        </div>

        <div style="margin-top: 20px;">
            <button id="btn-close-match" onclick="closeMatch()" style="background:#c0392b" disabled>Clôturer Match</button>
        </div>
    </div>

    <div class="card">
        <h2>Niveaux des Bots</h2>
        <table>
            <tr><th>Bot 1</th><th>Bot 2</th><th>Bot 3</th><th>Bot 4</th></tr>
            <tr><td id="lvl-0">8</td><td id="lvl-1">8</td><td id="lvl-2">8</td><td id="lvl-3">8</td></tr>
        </table>
    </div>

    <div class="card">
        <h2>Log d'activité (Temps réel)</h2>
        <div id="log-container"></div>
    </div>

    <script>
        const socket = io();
        const apiBaseUrl = window.location.origin;

        function updateUI(data) {
            const status = data.status || 'CLOSED';
            const badge = document.getElementById('match-status');
            badge.textContent = status;
            badge.className = 'status-badge ' + status;
            document.getElementById('match-id-display').textContent = data.matchId || '-';

            document.getElementById('btn-start-match').disabled = (status !== 'CLOSED');
            document.getElementById('btn-start-bonus').disabled = (status !== 'BETTING');
            document.getElementById('btn-stop-bonus').disabled = (status !== 'BONUS_ACTIVE');
            document.getElementById('btn-close-match').disabled = (status === 'CLOSED');

            if (data.bonusResults && data.bonusResults.botLevels) {
                data.bonusResults.botLevels.forEach((lvl, i) => {
                    document.getElementById(`lvl-${i}`).textContent = lvl;
                });
            }
        }

        function addLog(msg, isSuccess = true) {
            const container = document.getElementById('log-container');
            const div = document.createElement('div');
            div.className = isSuccess ? 'log-success' : 'log-fail';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.prepend(div);
        }

        async function startNewMatch() { fetch(`${apiBaseUrl}/admin/start-match`, { method: 'POST' }); }
        async function startBonusPhase() {
            const d = document.getElementById('bonus-duration').value;
            fetch(`${apiBaseUrl}/admin/start-bonus`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration: parseInt(d) })
            });
        }
        async function stopBonusPhase() { fetch(`${apiBaseUrl}/admin/stop-bonus`, { method: 'POST' }); }
        async function closeMatch() { if(confirm("Clôturer ?")) fetch(`${apiBaseUrl}/admin/close-match`, { method: 'POST' }); }

        socket.on('game-status', updateUI);
        socket.on('bonus-update', (data) => {
            const type = data.type || "Bonus";
            const input = data.input || "N/A";
            if (data.isSuccess) {
                addLog(`✨ SUCCÈS: ${data.user} -> ${type} (Bot ${input})`);
            } else {
                addLog(`❌ ÉCHEC: ${data.user} -> ${type} (Bot ${input}) | ${data.message}`, false);
            }
        });

        fetch(`${apiBaseUrl}/api/current-match`).then(r => r.json()).then(updateUI);
    </script>
</body>
</html>