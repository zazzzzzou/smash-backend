<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Administration Smash Betting</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .status-box { border: 2px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 4px; background-color: #e9ecef; }
        .status-box p { margin: 5px 0; }
        .status-box strong { font-weight: bold; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        #start-match { background-color: #28a745; color: white; }
        #start-bonus { background-color: #ffc107; color: #333; }
        #stop-bonus { background-color: #dc3545; color: white; }
        #close-match { background-color: #007bff; color: white; }
        #bonus-log li { margin-bottom: 5px; padding: 8px; border-bottom: 1px solid #eee; }
        .success { color: green; }
        .failure { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Panneau d'Administration Smash Betting</h1>

        <div class="status-box">
            <h2>Statut Actuel du Match</h2>
            <p><strong>Match ID:</strong> <span id="current-match-id">N/A</span></p>
            <p><strong>Statut:</strong> <span id="current-status">CLOSED</span></p>
            <p><strong>Pari Twitch ID:</strong> <span id="current-prediction-id">N/A</span></p>
        </div>

        <h2>Contr√¥les du Cycle de Jeu</h2>
        <div id="game-controls">
            <button id="start-match" onclick="startNewMatch()">D√©marrer Nouveau Match</button>
            <button id="close-match" onclick="closeMatchDb()">Cl√¥turer Match DB (Final)</button>
        </div>
        <hr>

        <h2>Contr√¥les de la Phase de Bonus</h2>
        <div id="bonus-controls">
            <p>
                <label for="bonus-duration">Dur√©e du Timer (secondes):</label>
                <input type="number" id="bonus-duration" value="60" min="10" max="300" style="width: 80px;">
            </p>
            <button id="start-bonus" onclick="startBonusPhase()">D√©marrer Phase Bonus</button>
            <button id="stop-bonus" onclick="stopBonusPhase()">Arr√™ter Phase Bonus Manuellement</button>
        </div>
        <hr>

        <h2>Statut des Bots et Bonus Utilis√©s</h2>
        <p>Ce tableau indique les actions Level Up/Down/Choix Perso qui sont **bloqu√©es**.</p>
        <table border="1" width="100%">
            <thead>
                <tr>
                    <th>Bot</th>
                    <th>Niveau Actuel (DB)</th>
                    <th>Level UP Bloqu√©</th>
                    <th>Level DOWN Bloqu√©</th>
                    <th>Choix Perso Bloqu√©</th>
                </tr>
            </thead>
            <tbody id="bot-status-table">
                </tbody>
        </table>
        
        <h3>Log des R√©compenses Utilis√©es (Match Actuel)</h3>
        <ul id="bonus-log">
            </ul>
    </div>

    <script>
        const socket = io();
        const apiBaseUrl = window.location.origin;

        const statusDisplay = document.getElementById('current-status');
        const matchIdDisplay = document.getElementById('current-match-id');
        const predictionIdDisplay = document.getElementById('current-prediction-id');
        const botStatusTable = document.getElementById('bot-status-table');
        const bonusLogList = document.getElementById('bonus-log');
        const bonusDurationInput = document.getElementById('bonus-duration');

        let currentMatchData = null;

        // Fonction pour mettre √† jour l'interface avec les donn√©es du match
        function updateUI(data) {
            currentMatchData = data;

            matchIdDisplay.textContent = data.matchId || 'N/A';
            statusDisplay.textContent = data.status || 'CLOSED';
            predictionIdDisplay.textContent = data.twitchPredictionId || 'N/A';
            
            // Logique des contr√¥les activ√©s/d√©sactiv√©s
            document.getElementById('start-match').disabled = data.status !== 'CLOSED';
            document.getElementById('start-bonus').disabled = data.status !== 'BETTING';
            document.getElementById('stop-bonus').disabled = data.status !== 'BONUS_ACTIVE';
            document.getElementById('close-match').disabled = data.status === 'CLOSED';

            // Mise √† jour du tableau des statuts des bots
            botStatusTable.innerHTML = '';
            if (data.bonusResults && data.bonusResults.botLevels) {
                for (let i = 0; i < data.bonusResults.botLevels.length; i++) {
                    const row = botStatusTable.insertRow();
                    row.insertCell().textContent = `Bot ${i + 1}`;
                    row.insertCell().textContent = data.bonusResults.botLevels[i];
                    row.insertCell().textContent = data.bonusResults.levelUpUsedForBot[i] ? 'OUI' : 'NON';
                    row.insertCell().textContent = data.bonusResults.levelDownUsedForBot[i] ? 'OUI' : 'NON';
                    row.insertCell().textContent = data.bonusResults.charSelectUsedForBot[i] ? 'OUI' : 'NON';
                }
            }
        }
        
        // --- API Calls ---

        function startNewMatch() {
            if (currentMatchData && currentMatchData.status !== 'CLOSED') {
                alert('Veuillez d\'abord cl√¥turer le match actuel.');
                return;
            }
            fetch(`${apiBaseUrl}/admin/start-match`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(`Match D√©marr√©. Statut: ${data.status}. Lancez le pari Twitch (Titre: [SMASH BET]...).`);
                    updateUI(data);
                })
                .catch(error => console.error('Erreur au d√©marrage du match:', error));
        }

        function startBonusPhase() {
            const duration = bonusDurationInput.value;
            fetch(`${apiBaseUrl}/admin/start-bonus`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ duration: duration })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Phase Bonus D√©marr√©e pour ${duration} secondes.`);
                updateUI(data);
            })
            .catch(error => console.error('Erreur au d√©marrage des bonus:', error));
        }

        function stopBonusPhase() {
            fetch(`${apiBaseUrl}/admin/stop-bonus`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('Phase Bonus arr√™t√©e manuellement.');
                    updateUI(data);
                })
                .catch(error => console.error('Erreur √† l\'arr√™t des bonus:', error));
        }
        
        function closeMatchDb() {
             if (!confirm("ATTENTION : Le pari Twitch doit √™tre RESOLVED manuellement avant de cl√¥turer la DB. Continuer?")) return;
             fetch(`${apiBaseUrl}/admin/close-match`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('Match DB cl√¥tur√©.');
                    updateUI(data);
                })
                .catch(error => console.error('Erreur √† la cl√¥ture du match:', error));
        }


        // --- Socket.IO Handlers ---
        
        socket.on('game-status', (data) => {
            updateUI(data);
            // R√©cup√©rer le match complet apr√®s un changement d'√©tat important
            fetchCurrentMatchData();
        });
        
        socket.on('bonus-update', (data) => {
            const listItem = document.createElement('li');
            const statusClass = data.isSuccess ? 'success' : 'failure';
            const statusText = data.isSuccess ? 'SUCC√àS' : '√âCHEC';
            
            listItem.className = statusClass;
            listItem.innerHTML = `[${statusText}] **${data.user}** a utilis√© **${data.type}** avec l'entr√©e: 
                                  "${data.input}". ${data.message ? `(${data.message})` : ''}`;
            
            bonusLogList.prepend(listItem);
        });

        function fetchCurrentMatchData() {
            fetch(`${apiBaseUrl}/api/current-match`)
                .then(response => response.json())
                .then(data => {
                    if (data.status) {
                         updateUI(data);
                         // Remplir le log si des donn√©es de log existent
                         if (data.bonusResults && data.bonusResults.log) {
                            bonusLogList.innerHTML = '';
                            data.bonusResults.log.reverse().forEach(log => {
                                const listItem = document.createElement('li');
                                listItem.className = 'success'; // On ne log que les succ√®s dans la DB
                                listItem.innerHTML = `[SUCC√àS] **${log.user}** a utilis√© **${log.reward}** avec l'entr√©e: 
                                                      "${log.input}" le ${new Date(log.timestamp).toLocaleTimeString()}`;
                                bonusLogList.appendChild(listItem);
                            });
                         }
                    }
                })
                .catch(error => console.error('Erreur lors de la r√©cup√©ration de l\'√©tat initial:', error));
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', fetchCurrentMatchData);

    </script>
</body>
</html>