<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SMASH BETTING - Administration</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .action-group { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; color: white; margin-right: 10px; }
        #startMatchBtn { background-color: #4CAF50; }
        #allowBonusBtn { background-color: #f44336; }
        #closeMatchBtn { background-color: #008CBA; }
        #setActiveBtn { background-color: #4CAF50; } 
        #setHiddenBtn { background-color: #333; } 
        .info { margin-top: 15px; padding: 10px; background-color: #eee; border-radius: 4px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Panneau Admin Smash Betting</h1>

        <div class="action-group">
            <h2>Configuration du Pari (Prediction)</h2>
            <form id="predictionConfigForm">
                <label for="title">Titre du Pari :</label>
                <input type="text" id="title" name="title" value="Quel Bot va gagner ?" required>

                <label for="outcome1">Choix 1 (Bot 1) :</label>
                <input type="text" id="outcome1" name="outcome1" value="Bot 1 (Kirby)" required>
                <label for="outcome2">Choix 2 (Bot 2) :</label>
                <input type="text" id="outcome2" name="outcome2" value="Bot 2 (Samus)" required>
                <label for="outcome3">Choix 3 (Bot 3) :</label>
                <input type="text" id="outcome3" name="outcome3" value="Bot 3 (Captain Falcon)" required>
                <label for="outcome4">Choix 4 (Bot 4) :</label>
                <input type="text" id="outcome4" name="outcome4" value="Bot 4 (Pikachu)" required>

                <label for="duration">Dur√©e du Pari (en secondes) :</label>
                <input type="number" id="duration" name="duration" value="90" min="30" max="1800" required>
            </form>
        </div>

        <div class="action-group">
            <h2>Phases de Jeu</h2>
            <button id="startMatchBtn">1. D√âMARRER NOUVEAU MATCH & LANCER PARI</button>
            <button id="allowBonusBtn">2. AUTORISER BONUS (10s)</button>
        </div>

        <div class="action-group">
            <h2>Cl√¥ture et R√©sultats</h2>
            <form id="closeForm">
                <label for="winner">Gagnant (Bot 1-4) :</label>
                <input type="number" id="winner" name="winner" min="1" max="4" required>
                <button type="submit" id="closeMatchBtn">3. CL√îTURER MATCH & PAYER</button>
            </form>
        </div>
        
        <div class="action-group">
            <h2>‚ö°Ô∏è Contr√¥le d'√âtat Manuel (Pour D√©bug Extr√™me)</h2>
            <button id="setActiveBtn">Forcer Actif/Visible</button>
            <button id="setHiddenBtn">Forcer Cach√©/Inactif (Repos)</button>
            <p>Utilisez ceci uniquement si le cycle est rompu.</p>
        </div>

        <div class="info">
            Statut Actuel du Jeu : <span id="gameStatus">CHARGEMENT...</span><br>
            Match ID : <span id="matchId">N/A</span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const baseUrl = window.location.origin;

        function updateStatusDisplay(status, matchId) {
            const statusText = status || 'N/A'; 
            document.getElementById('gameStatus').textContent = statusText + ' (MAJ)';
            if (matchId) {
                document.getElementById('matchId').textContent = matchId;
            }
        }

        socket.on('game-status', (data) => {
            updateStatusDisplay(data.status, data.matchId);
        });

        // Fonction pour envoyer une requ√™te POST
        async function sendAction(endpoint, body = {}) {
            try {
                const response = await fetch(`${baseUrl}/admin/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    // Tente de lire le message d'erreur si la r√©ponse n'est pas OK
                    const errorData = await response.json().catch(() => ({ message: "Erreur serveur inconnue." }));
                    throw new Error(`HTTP Error! Status: ${response.status}. Message: ${errorData.message}`);
                }
                const data = await response.json();
                
                console.log(`Action ${endpoint} r√©ussie. R√©ponse re√ßue:`, data);
                updateStatusDisplay(data.status, data.matchId);

            } catch (error) {
                alert(`Erreur lors de l'action ${endpoint}. Consultez la console.`);
                console.error(error);
            }
        }

        // --- Listeners de Flux de Jeu ---
        document.getElementById('startMatchBtn').addEventListener('click', () => {
            const form = document.getElementById('predictionConfigForm');
            const outcomes = [
                { title: form.outcome1.value, id: 1 },
                { title: form.outcome2.value, id: 2 },
                { title: form.outcome3.value, id: 3 },
                { title: form.outcome4.value, id: 4 },
            ];
            
            const betConfig = {
                title: form.title.value,
                outcomes: outcomes,
                duration: parseInt(form.duration.value, 10)
            };
            
            sendAction('start-match', betConfig);
        });

        document.getElementById('allowBonusBtn').addEventListener('click', () => {
            sendAction('allow-bonus');
        });

        document.getElementById('closeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const winnerBot = document.getElementById('winner').value;
            sendAction('close-match', { winner: winnerBot });
        });
        
        // --- Listeners de Contr√¥le Manuel ---
        document.getElementById('setActiveBtn').addEventListener('click', () => {
            sendAction('set-active');
        });
        document.getElementById('setHiddenBtn').addEventListener('click', () => {
            sendAction('set-hidden');
        });

    </script>
</body>
</html>